version: 1
applications:
- appRoot: application
  backend:
    phases:
      build:
        commands:
          # npm install une seule fois ici, réutilisé par le frontend
          #- npm install --cache .npm --prefer-offline
          - npm --version
          - node -v          
          - npm ci --cache .npm --prefer-offline
          - chmod +x scripts/deploy-backend.sh && ./scripts/deploy-backend.sh
  frontend:
    phases:
      preBuild:
        commands:
          # node_modules déjà installé par le backend
          - chmod +x scripts/generate-outputs.sh && ./scripts/generate-outputs.sh
      build:
        commands:
          - npm run build
    artifacts:
      baseDirectory: .next
      files:
        - '**/*'
    cache:
      paths:
        - .npm/**/*
        - node_modules/**/*
        - .next/cache/**/*
